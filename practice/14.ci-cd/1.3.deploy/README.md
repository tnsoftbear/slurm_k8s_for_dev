# Добавляем конфиг CI/CD в Gitlab

В этой части добавляем последний шаг - конфиг для Gitlab CI/CD для сборки, тестирования и деплоя приложения в кластер k8s. Деплой производится с использованием утилиты Helm v3.

Gitlab CI/CD описывается в файле `.gitlab-ci.yml` в формате `yaml`. По умолчанию Gitlab ищет этот файл в корне проекта, путь до файла может быть переопределен в настройках проекта.

## 1. Подготавливаем CI/CD

Для этого скопируем заранее подготовленный шаблон `.gitlab-ci.yml` в проект `xpaste`, выполнив команду:

```bash
cp ~/slurm/practice/14.ci-cd/1.3.deploy/.gitlab-ci.yml ~/xpaste/
```

## 2. Адрес Kubernetes API

В файле `.gitlab-ci.yml` вам необходимо заменить плейсхолдер на реальный адрес вашего мастера Kubernetes.
Для того чтобы его узнать можно выполнить командн

```bash
kubectl get node -o wide
```


## 2. Настройка ingress

Доступ к приложению будет осуществляться через ingress. Ingress устанавливается вместе с приложением, но для его корректной работы необходимо прописать ему адрес.
Для этого откроем `values.yaml`:

```bash
vi ~/xpaste/.helm/values.yaml
```

В конце файла необходимо заменить строку `<Ваш номер логина> - меняем на свой номер студента!!`:

```diff
- host: xpaste.s<Ваш номер логина>.edu.slurm.io
+ host: xpaste.s000001.edu.slurm.io
```

Сохраняем все изменения и пушим их в gitlab. Для этого необходимо выполнить команды:

```bash
cd ~/xpaste
git add .
git commit -am "Add CI/CD config"
git push
```

## 3. Переключаемся в namespace приложения

Наше приложение xpaste устанавливается в другой namespace `s<номер_студента>-xpaste-production`.
Для удобства работы, чтобы не набирать каждый раз опцию `--namespace` изменим namespace, который kubectl использует по умолчанию:

```bash
kubectl config set-context --current --namespace=s<номер_студента>-xpaste-production
```

## 4. Проверка результата

Для проверки результата необходимо перейти в Gitlab в раздел `ci/cd -> pipelines` форка проекта xpaste.
Можно воспользоваться прямой ссылкой: `https://gitlab.slurm.io/sXXXXXX/xpaste/pipelines`. `sXXXXXX` необходимо заменить на номер своего студента.

В результате все job должны закончиться без ошибок.

## 5.Открываем приложение в браузере

В браузере открываем URL: http://xpaste.s<Ваш номер логина>.edu.slurm.io. `<Ваш номер логина>` необходимо заменить на номер своего студента. Открывать нужно в режиме `инкогнито`.
